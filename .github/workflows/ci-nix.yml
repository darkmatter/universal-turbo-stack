name: CI (Experimental)
on:
  # uncomment when working correctly
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]
  merge_group:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
env:
  FORCE_COLOR: 3
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
jobs:
  # treefmt can be run like this because it natively handles filtering by
  # the diff between the current HEAD and base branch.
  format:
    runs-on: self-hosted
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5
      - name: Format
        uses: ./tooling/github/nix
        with:
          command: treefmt --ci | tee format-output.txt
          # - name: Report
          #   if: always()
          #   uses: becheran/go-testreport@v0.3.2
          #   with:
          #     input: format-output.txt
  paths-filter:
    runs-on: self-hosted
    outputs:
      changes: ${{ steps.filter.outputs.changes }}
      # changes: '["apollo", "nn", "turbo"]'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - id: filter
        uses: dorny/paths-filter@v2
        with:
          base: ${{ github.event_name == 'pull_request' && github.base_ref || github.ref_name }}
          filters: |
            apollo:
              - 'apps/apollo/**'
            nn:
              - 'apps/nn/**'
            turbo:
              - 'apps/nextjs/**'
              - 'apps/expo/**'
              - 'tooling/**'
              - 'packages/**'
  # This should run all checks excluding formatting which is handled above
  checks:
    name: "Run Checks (${{ matrix.lane }})"
    runs-on: self-hosted
    continue-on-error: true
    permissions:
      id-token: write
      contents: read
    needs:
      - paths-filter
      - format
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: apollo
            filter: apollo
            ssm_paths: |
              /dev/apollo
            task: apollo:checks:ci
          - lane: nn
            filter: nn
            ssm_paths: |
              /dev/nn
            task: nn:checks:ci
          - lane: turbo
            filter: turbo
            ssm_paths: |
              /dev/nextjs
            task: turbo:checks:ci
    steps:
      - uses: actions/checkout@v5
      - name: Run Checks (${{ matrix.lane }})
        id: run_checks
        if: contains(fromJSON(needs.paths-filter.outputs.changes), matrix.filter)
        uses: ./tooling/github/nix
        with:
          command: |
            set -euo pipefail
            LOG_FILE="${RUNNER_TEMP}/checks-${{ matrix.lane }}.log"
            rm -f "${LOG_FILE}"
            devenv tasks run ${{ matrix.task }} |& tee "${LOG_FILE}"
          ssm_paths: ${{ matrix.ssm_paths }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
        env:
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      - name: Summarize checks for ${{ matrix.lane }}
        if: always() && contains(fromJSON(needs.paths-filter.outputs.changes), matrix.filter)
        run: |
          outcome="${{ steps.run_checks.outcome }}"
          log_file="${RUNNER_TEMP}/checks-${{ matrix.lane }}.log"
          {
            echo "### Checks for \`${{ matrix.lane }}\`"
            echo ""
            if [ "${outcome}" = "success" ]; then
              echo "Result: success."
            else
              echo "Result: failure. See logs above."
              if [ -f "${log_file}" ]; then
                echo ""
                echo "<details><summary>Last 200 lines</summary>"
                echo ""
                echo '```text'
                tail -n 200 "${log_file}"
                echo '```'
                echo ""
                echo "</details>"
              fi
            fi
            echo ""
            echo "<details><summary>Command</summary>"
            echo ""
            echo '```bash'
            printf 'devenv task %s\n' "${{ matrix.task }}"
            echo '```'
            echo ""
            echo "</details>"
          } >> "${GITHUB_STEP_SUMMARY}"
      - name: No changes detected for ${{ matrix.lane }}
        if: contains(fromJSON(needs.paths-filter.outputs.changes), matrix.filter) == false
        run: echo "Skipping checks; no files changed for ${{ matrix.lane }}."
      - name: Summarize skipped checks for ${{ matrix.lane }}
        if: contains(fromJSON(needs.paths-filter.outputs.changes), matrix.filter) == false
        run: |
          {
            echo "### Checks for \`${{ matrix.lane }}\`"
            echo ""
            echo "Result: skipped; no relevant changes detected."
          } >> "${GITHUB_STEP_SUMMARY}"
  tests:
    name: Tests (${{ matrix.lane }})
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read
    needs:
      - paths-filter
      - checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - lane: apollo
            filter: apollo
            cwd: apps/apollo
            task: apollo:test:ci
          - lane: nn
            filter: nn
            cwd: apps/nn
            task: nn:test:ci
          - lane: turbo
            filter: turbo
            cwd: .
            task: tests:turbo:ci
    steps:
      - uses: actions/checkout@v5
      - name: Run lane command
        if: contains(fromJSON(needs.paths-filter.outputs.changes), matrix.lane)
        uses: ./tooling/github/nix
        with:
          cwd: ${{ matrix.cwd }}
          command: |
            set -euo pipefail
            devenv task ${{ matrix.task }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: No changes detected for ${{ matrix.lane }}
        if: contains(fromJSON(needs.paths-filter.outputs.changes), matrix.lane) == false
        run: echo "Skipping tests; no files changed for ${{ matrix.lane }}."
      - name: Report (Go Tests)
        if: always() && contains(fromJSON(needs.paths-filter.outputs.changes), 'apollo') && matrix.lane == 'apollo'
        uses: robherley/go-test-action@v0.6.0
        with:
          fromJSONFile: apps/apollo/report.json
      - name: Report (Pytest)
        if: always() && contains(fromJSON(needs.paths-filter.outputs.changes), 'nn') && matrix.lane == 'nn'
        uses: dorny/test-reporter@v1
        with:
          name: Pytest Results
          path: apps/nn/pytest-report.xml
          reporter: java-junit
      - name: Report (Vitest)
        # Set if: always() to also generate the report if tests are failing
        # Only works if you set `reportOnFailure: true` in your vite config as specified above
        # only post if this is a pull request
        if: always() && github.event_name == 'pull_request' && contains(fromJSON(needs.paths-filter.outputs.changes), 'turbo')
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          json-summary-path: packages/vitest-config/coverage/coverage-summary.json
          json-final-path: packages/vitest-config/coverage/merged/merged-coverage.json
  docker:
    name: Build & Push (${{ matrix.image }})
    runs-on: self-hosted
    needs: tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: apollo
            filter: apollo
            dockerfile: apps/apollo/Dockerfile
            context: .
          - image: nn
            filter: nn
            dockerfile: apps/nn/Dockerfile
            context: .
          - image: nextjs
            filter: turbo
            dockerfile: tooling/docker/nextjs.Dockerfile
            context: .
    permissions:
      id-token: write
      contents: read
    env:
      REGISTRY: 950224716579.dkr.ecr.us-west-2.amazonaws.com/darkmatter/apollo
      AWS_REGION: us-west-2
    steps:
      - uses: actions/checkout@v5
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::950224716579:role/GitHubActionsECRPush-apollo
          aws-region: ${{ env.AWS_REGION }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region "${AWS_REGION}" | docker login --username AWS --password-stdin "${REGISTRY}"
      - name: Build and push ${{ matrix.image }}
        uses: ./tooling/github/nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          command: |
            set -euo pipefail
            TAG="$(echo "${GITHUB_SHA}" | cut -c1-12)"
            build_args=(
              "--push"
              "--platform" "linux/amd64"
              "--file" "${{ matrix.dockerfile }}"
              "--tag" "${REGISTRY}/${{ matrix.image }}:${TAG}"
            )
            if [ "${GITHUB_REF}" = "refs/heads/nix" ]; then
              build_args+=("--tag" "${REGISTRY}/${{ matrix.image }}:latest")
            fi
            build_args+=("${{ matrix.context }}")
            docker buildx build "${build_args[@]}"
